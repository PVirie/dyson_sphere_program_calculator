<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="./Virie_symbol_2023.svg" />
        <link rel="stylesheet" href="./styles/theme.css" />
        <link rel="stylesheet" href="./styles/layout.css" />
        <title>Dyson sphere program calculator</title>
    </head>
    <body>
        <div class="container">
            <div id="product-list" class="list"></div>
            <div id="base-list" class="list"></div>
            <div id="production-list" class="list"></div>
            <div id="control" class="control">
                <input id="calculate-button" type="button" value="Calculate" />
                <div id="result" class="list"></div>
            </div>
        </div>
        <script src="./thirdparties/highs.js"></script>
        <script src="./src/optimal_process.js"></script>
        <script type="text/javascript">
            const add_numeric_item = function (parent, name) {
                const elem = document.createElement("div");
                const label = document.createElement("label");
                label.for = name;
                label.innerText = name;
                elem.appendChild(label);
                const item = document.createElement("input");
                item.classList.add("item");
                item.type = "number";
                item.name = name;
                item.value = 0;
                item.min = 0;
                item.max = 1000000;
                item.step = 0.01;
                elem.appendChild(item);
                parent.appendChild(elem);
            };

            const add_boolean_item = function (parent, name) {
                const elem = document.createElement("div");
                const label = document.createElement("label");
                label.for = name;
                label.innerText = name;
                elem.appendChild(label);
                const item = document.createElement("input");
                item.classList.add("item");
                item.type = "checkbox";
                item.name = name;
                elem.appendChild(item);
                parent.appendChild(elem);
            };

            window.addEventListener("load", async function () {
                const r = await fetch("/data/craft_table", {
                    method: "GET",
                });
                if (r.status !== 200) {
                    console.error("Failed to fetch craft table");
                    return;
                }
                const data = await r.json();

                const product_list = document.getElementById("product-list");
                const base_list = document.getElementById("base-list");
                const production_list = document.getElementById("production-list");

                const all_products = {};
                const all_bases = {};
                const all_productions = {};
                for (const datum of data) {
                    for (const p of datum.products) {
                        if (all_products[p.id] == null) {
                            all_products[p.id] = 0;
                            add_numeric_item(product_list, p.id);
                        }
                    }
                    const is_base = datum.requires.length === 0;
                    if (is_base) {
                        for (const p of datum.products) {
                            all_bases[p.id] = 0;
                            add_numeric_item(base_list, p.id);
                        }
                    }
                    prod_id = `${datum.products.map((p) => p.id).join(" & ")} from ${datum.requires.map((p) => p.id).join(" & ")}`;
                    all_productions[prod_id] = false;
                    add_boolean_item(production_list, prod_id);
                }

                const highs_settings = {
                    // In the browser, point locateFile to the URL of the wasm file (see below)
                    locateFile: (file) => "/thirdparties/" + file,
                };
                const highs = await Module(highs_settings);

                const calculate_button = document.getElementById("calculate-button");
                const result = document.getElementById("result");
                calculate_button.addEventListener("click", async function (e) {
                    // require_resource_rate: num_resource x num_production
                    // production_speed : num_resource x num_production
                    // allowed_production : num_production
                    // target_speed : num_resource
                    // base_production_cost: num_production

                    const require_resource_rate = [];

                    const params = op.build_matrices(require_resource_rate, production_speed, allowed_production, target_speed);

                    const PROBLEM = `Minimize
                        obj:
                            ${params.obj}
                        Subject To
                            ${params.constraints
                                .map((c, i) => {
                                    return `c${i}: ${c}`;
                                })
                                .join("\n")}
                        Bounds
                            ${params.bounds.join("\n")}
                        End`;

                    console.log(PROBLEM);

                    const sol = highs.solve(PROBLEM);
                    console.log(sol);
                });
            });
        </script>
    </body>
</html>
